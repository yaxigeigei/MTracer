classdef MKilosort4
    % MKilosort4 is a class that provides a set of static methods for loading and manipulating Kilosort 4 options.

    methods(Static)
        function ops = LoadPyOps(opsFileNpy)
            % Load options from ops.npy file generated by Kilosort 4
            % 
            %   ops = MKilosort4.LoadPyOps(opsFileNpy)
            % 
            
            np = py.importlib.import_module('numpy');
            mmap_mode=string(missing);
            allow_pickle=true;
            ops = np.load(opsFileNpy, mmap_mode,allow_pickle).item();
            
            % Remove the looped field (ops.settings.settings...) to avoid infinite recursion
            ops = struct(ops);
            ops.settings = struct(ops.settings);
            ops.settings = rmfield(ops.settings, 'settings');
            
            % Convert all fields to MATLAB types
            ops = MUtil.ConvertNpyTypes(ops, 'Recursive', true, 'KeepUnsupported', false);
            
            % Derive additional fields
            ops.tstart = round(ops.tmin * ops.fs);
            if isinf(ops.tmax)
                ops.tend = ops.tstart + size(mdat.Data.V, 2);
            else
                ops.tend = round(ops.tmax * ops.fs);
            end
            ops.trange = [ops.tmin ops.tmax];
        end
        
    end
    
end
